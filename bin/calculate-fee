#!/usr/bin/env php
<?php

use Lendable\Interview\DataTransferObject\Loan\LoanRequestData;
use Lendable\Interview\Service\Breakpoint\DummyLoanTermBreakpointService;
use Lendable\Interview\Service\Calculator\LoanFeeCalculatorService;
use Lendable\Interview\Validator\LoanRequestValidator;

require_once dirname(__DIR__) . '/vendor/autoload.php';

$dotenv = Dotenv\Dotenv::createImmutable(__DIR__);
$dotenv->safeLoad();

/**
 * Please note that you CAN modify this file in any way to suit your needs, but be advised that it MUST conform to
 * the contract specified in the README of the test.
 */
try {
    $fee = getFeeCalculator()
        ->execute(new LoanRequestData(...getSanitisedArgs($argv)))
        ->getFormattedFee();

    printf("%s%s", $fee, PHP_EOL); // stdout

    exit(0);
} catch (Throwable $e) {
    fwrite(
        STDERR,
        sprintf(
            'Error: %s%s',
            $e->getMessage(),
            PHP_EOL
        )
    ); // stderr
    exit(1);
}

function getSanitisedArgs(array $argv): array
{
    return new LoanRequestValidator(
        amount: $argv[1] ?? null,
        term: $argv[2] ?? null
    )->validate()->safe();
}

function getFeeCalculator(): LoanFeeCalculatorService
{
    return new LoanFeeCalculatorService(
        termBreakpointService: new DummyLoanTermBreakpointService(),
        roundingFeeInterval: (int)($_ENV['FEE_ROUNDING_INTERVAL'] ?? 5)
    );
}
